<script>
"use strict";
var _createClass = function() {
    function defineProperties(target, props) {
        for (var i = 0; i < props.length; i++) {
            var descriptor = props[i];
            descriptor.enumerable = descriptor.enumerable || false;
            descriptor.configurable = true;
            if ("value" in descriptor) descriptor.writable = true;
            Object.defineProperty(target, descriptor.key, descriptor)
        }
    }
    return function(Constructor, protoProps, staticProps) {
        if (protoProps) defineProperties(Constructor.prototype, protoProps);
        if (staticProps) defineProperties(Constructor, staticProps);
        return Constructor
    }
}();

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function")
    }
}
var _marked2 = [generate].map(regeneratorRuntime.mark);

function linkRight(box, gap, height, width) {
    return new Box(box.r + gap, box.t - height, width, height)
}

function linkUpr(box) {
    return new Box(randi(box.x + 1, box.r + 3), box.t + 2, randi(1, 8), 1)
}

function linkUpl(box) {
    var w = randi(1, 8);
    return new Box(randi(box.x - w - 2, box.r - w - 1), box.t + 2, w, 1)
}

function drop(box) {
    var w = randi(4, 8),
        d = randi(5, 15);
    return new Box(box.r - w / 2, box.y - d, w, randi(1, 4))
}

function generate() {
    var _marked, newbox, repeat, RIGHT, UPRIGHT, UPLEFT, UP, DROP, prevdir, i, newdir;
    return regeneratorRuntime.wrap(function generate$(_context2) {
        while (1) {
            switch (_context2.prev = _context2.next) {
                case 0:
                    repeat = function repeat(n, f) {
                        var i;
                        return regeneratorRuntime.wrap(function repeat$(_context) {
                            while (1) {
                                switch (_context.prev = _context.next) {
                                    case 0:
                                        i = 0;
                                    case 1:
                                        if (!(i < n)) {
                                            _context.next = 7;
                                            break
                                        }
                                        _context.next = 4;
                                        return newbox = f(newbox);
                                    case 4:
                                        i++;
                                        _context.next = 1;
                                        break;
                                    case 7:
                                    case "end":
                                        return _context.stop();
                                }
                            }
                        }, _marked[0], this)
                    };
                    _marked = [repeat].map(regeneratorRuntime.mark);
                    newbox = new Box(-5, -4, 10, 1);
                    _context2.next = 5;
                    return newbox;
                case 5:
                    RIGHT = 0, UPRIGHT = 1, UPLEFT = 2, UP = 3, DROP = 4;
                    prevdir = 0;
                    return _context2.delegateYield(repeat(3, function() {
                        return newbox = linkRight(newbox, 2, randi(1, 4), randi(1, 5))
                    }), "t0", 8);
                case 8:
                    i = localStorage.getItem("level_size") || 20;
                case 9:
                    if (!(i-- > 0)) {
                        _context2.next = 39;
                        break
                    }
                    newdir = randarr([RIGHT, RIGHT, RIGHT, UPRIGHT, UPLEFT, UP, DROP, DROP, DROP]);
                    _context2.t1 = newdir;
                    _context2.next = _context2.t1 === RIGHT ? 14 : _context2.t1 === UPRIGHT ? 21 : _context2.t1 === UPLEFT ? 23 : _context2.t1 === UP ? 28 : _context2.t1 === DROP ? 30 : 35;
                    break;
                case 14:
                    if (!(prevdir == RIGHT)) {
                        _context2.next = 16;
                        break
                    }
                    return _context2.abrupt("continue", 37);
                case 16:
                    if (!(prevdir == UPLEFT)) {
                        _context2.next = 19;
                        break
                    }
                    _context2.next = 19;
                    return newbox = linkUpr(newbox);
                case 19:
                    return _context2.delegateYield(repeat(randi(3, 6), function(cur) {
                        return linkRight(cur, randi(1, 5), randi(1, 4), randi(1, 5))
                    }), "t2", 20);
                case 20:
                    return _context2.abrupt("break", 36);
                case 21:
                    return _context2.delegateYield(repeat(4, linkUpr), "t3", 22);
                case 22:
                    return _context2.abrupt("break", 36);
                case 23:
                    if (!(prevdir == RIGHT)) {
                        _context2.next = 25;
                        break
                    }
                    return _context2.abrupt("continue", 37);
                case 25:
                    newbox.navi = "upl";
                    return _context2.delegateYield(repeat(randi(1, 3), linkUpl), "t4", 27);
                case 27:
                    return _context2.abrupt("break", 36);
                case 28:
                    return _context2.delegateYield(repeat(randi(2, 6), randarr([linkUpl, linkUpr])), "t5", 29);
                case 29:
                    return _context2.abrupt("break", 36);
                case 30:
                    if (!(prevdir == UPLEFT || prevdir == UP)) {
                        _context2.next = 32;
                        break
                    }
                    return _context2.abrupt("continue", 37);
                case 32:
                    newbox.navi = "drop";
                    return _context2.delegateYield(repeat(randi(1, 3), drop), "t6", 34);
                case 34:
                    return _context2.abrupt("break", 36);
                case 35:
                    return _context2.abrupt("break", 36);
                case 36:
                    prevdir = newdir;
                case 37:
                    _context2.next = 9;
                    break;
                case 39:
                    _context2.next = 41;
                    return linkRight(newbox, 2, 5, 5);
                case 41:
                case "end":
                    return _context2.stop();
            }
        }
    }, _marked2[0], this)
}
var Level = function() {
    function Level() {
        _classCallCheck(this, Level);
        this.boxes = [];
        var levelw = 100,
            levelh = 50;
        this.width = levelw;
        this.height = levelh;
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;
        try {
            for (var _iterator = generate()[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var gbox = _step.value;
                this.boxes.push(gbox)
            }
        } catch (err) {
            _didIteratorError = true;
            _iteratorError = err
        } finally {
            try {
                if (!_iteratorNormalCompletion && _iterator.return) {
                    _iterator.return()
                }
            } finally {
                if (_didIteratorError) {
                    throw _iteratorError
                }
            }
        }
        for (var i = 0; i < this.boxes.length; i++) {
            var box = this.boxes[i];
            var _box = new Box(box.x, box.y - 101, box.w, 100);
            if (!this.collide(_box)) this.boxes[i] = new Box(box.x, box.y - 100, box.w, 100 + box.h)
        }
        this.objects = this.boxes.map(function(x) {
            return {
                bounds: x
            }
        })
    }
    _createClass(Level, [{
        key: "collide",
        value: function collide(box) {
            return this.boxes.find(function(b) {
                return b && b != box && b.intersects(box)
            })
        }
    }, {
        key: "doodads",
        value: regeneratorRuntime.mark(function doodads() {
            var _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, box, j, sign;
            return regeneratorRuntime.wrap(function doodads$(_context3) {
                while (1) {
                    switch (_context3.prev = _context3.next) {
                        case 0:
                            _context3.next = 2;
                            return ["signRight", new Point(-2, -2.5)];
                        case 2:
                            _iteratorNormalCompletion2 = true;
                            _didIteratorError2 = false;
                            _iteratorError2 = undefined;
                            _context3.prev = 5;
                            _iterator2 = this.boxes[Symbol.iterator]();
                        case 7:
                            if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
                                _context3.next = 25;
                                break
                            }
                            box = _step2.value;
                            if (!(box.navi == "upl")) {
                                _context3.next = 12;
                                break
                            }
                            _context3.next = 12;
                            return ["signLeft", new Point(box.x + box.w / 2, box.t + 0.5)];
                        case 12:
                            if (!(box.navi == "drop")) {
                                _context3.next = 15;
                                break
                            }
                            _context3.next = 15;
                            return ["boxItem", new Point(box.r - 0.6, box.t - 0.6)];
                        case 15:
                            j = box.w * 2;
                        case 16:
                            if (!(j-- > 0)) {
                                _context3.next = 22;
                                break
                            }
                            if (!(random() < 0.2)) {
                                _context3.next = 20;
                                break
                            }
                            _context3.next = 20;
                            return [randarr(["bush", "grass", "rock", "grass", "bush", "grass", "rock", "mushroomBrown", "mushroomRed"]), new Point(box.x + 0.5 + random() * (box.w - 1), box.t + 0.5)];
                        case 20:
                            _context3.next = 16;
                            break;
                        case 22:
                            _iteratorNormalCompletion2 = true;
                            _context3.next = 7;
                            break;
                        case 25:
                            _context3.next = 31;
                            break;
                        case 27:
                            _context3.prev = 27;
                            _context3.t0 = _context3["catch"](5);
                            _didIteratorError2 = true;
                            _iteratorError2 = _context3.t0;
                        case 31:
                            _context3.prev = 31;
                            _context3.prev = 32;
                            if (!_iteratorNormalCompletion2 && _iterator2.return) {
                                _iterator2.return()
                            }
                        case 34:
                            _context3.prev = 34;
                            if (!_didIteratorError2) {
                                _context3.next = 37;
                                break
                            }
                            throw _iteratorError2;
                        case 37:
                            return _context3.finish(34);
                        case 38:
                            return _context3.finish(31);
                        case 39:
                            sign = this.boxes[this.boxes.length - 1].max;
                            this.boxes.push(this.exit = new Box(sign.x - 3, sign.y - 1, 2, 3));
                            _context3.next = 43;
                            return ["signExit", {
                                x: sign.x - 1.5,
                                y: sign.y + 0.5
                            }];
                        case 43:
                            _context3.next = 45;
                            return ["doorClosed_mid", {
                                x: sign.x - 2.5,
                                y: sign.y + 0.5
                            }];
                        case 45:
                            _context3.next = 47;
                            return ["doorClosed_top", {
                                x: sign.x - 2.5,
                                y: sign.y + 1.5
                            }];
                        case 47:
                        case "end":
                            return _context3.stop();
                    }
                }
            }, doodads, this, [
                [5, 27, 31, 39],
                [32, , 34, 38]
            ])
        })
    }]);
    return Level
}();
</script>